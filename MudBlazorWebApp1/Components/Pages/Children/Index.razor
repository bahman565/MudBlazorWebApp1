@page "/children"
@using MudBlazorWebApp1.Models
@using MudBlazorWebApp1.Services
@inject ChildService ChildService
@inject UserContext UserContext
@inject NavigationManager Nav
@inject SelectedChildService SelectedChildService

<style>
    body {
        direction: ltr;
        background-color: #ffffff;
        font-family: Vazirmatn
    }
</style>

<PageTitle>Children</PageTitle>
<MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
    <MudText Typo="Typo.h5">کودکان</MudText>
    <div style="margin-top:10px">
        <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Tertiary" OnClick="@(() => Nav.NavigateTo("/children/new"))">
            افزودن کودک
        </MudButton>
    </div>
</MudStack>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_items.Count == 0)
{
    <MudAlert Severity="Severity.Info">هنوز کودکی ثبت نشده است.</MudAlert>
}
else
{
    <MudTable Items="_items" Hover="true" Dense="true" Style="background-color:#deebe9">
        <HeaderContent>
            <MudTh>نام</MudTh>
            <MudTh>جنسیت</MudTh>
            <MudTh>تاریخ تولد</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="نام">@context.Name</MudTd>
            <MudTd DataLabel="جنسیت">@GenderFa(context.Gender)</MudTd>
            <MudTd DataLabel="تولد">@context.BirthDate</MudTd>
            <MudTd>
                <MudButton Size="Size.Small" Variant="Variant.Filled" Color="MudBlazor.Color.Secondary"
                           OnClick="@(() => SelectChildAndNavigate(context.Id))">
                    اندازه گیری
                </MudButton>
                <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="MudBlazor.Color.Info" Class="ml-2"
                           OnClick="@(() => Nav.NavigateTo($"/children/edit/{context.Id}"))">
                    ویرایش
                </MudButton>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool _loading = true;
    private List<Child> _items = new();

    protected override async Task OnInitializedAsync()
    {
        var userId = await UserContext.GetUserIdAsync();
        _items = await ChildService.GetMyChildrenAsync(userId);
        _loading = false;
    }

    private void SelectChildAndNavigate(int childId)
    {
        SelectedChildService.SelectedChildId = childId;  // ← ذخیره شدن شناسهٔ کودک
        Nav.NavigateTo($"/children/{childId}");
    }

    private static string GenderFa(ChildGender g) => g == ChildGender.Male ? "پسر" : "دختر";
}