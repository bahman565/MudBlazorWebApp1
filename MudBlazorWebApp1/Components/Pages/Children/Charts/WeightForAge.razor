@page "/children/{Id:int}/charts/weight-for-age"
@using MudBlazorWebApp1.Models
@using MudBlazorWebApp1.Services
@using ApexCharts
@inject ChildService ChildService
@inject UserContext UserContext
@inject GrowthReferenceQueryService RefService

<MudText Typo="Typo.h5" Class="mb-2">نمودار وزن به سن</MudText>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_child is null)
{
    <MudAlert Severity="Severity.Error">کودک پیدا نشد.</MudAlert>
}
else
{


    <MudPaper Class="pa-3 mb-4" Elevation="0" Outlined="true" Height="30px" Style="background-color:#8bb9d0 ">
        <MudGrid Spacing="2">

            <MudText Typo="Typo.subtitle1" Class="mb-2" Style="font-size:15px" Align="MudBlazor.Align.Center">
                @_child.Name — @(_child.Gender == ChildGender.Male ? "پسر" : "دختر")
            </MudText>
            
        </MudGrid>
    </MudPaper>

    <ApexChart @key="_chartKey"
               TItem="Point"
               Title="Weight-for-Age (Mashhad)"
               Options="_options"
               Height="500">

        @* Percentiles (always line) *@
        @foreach (var series in _percentileSeries)
        {
            <ApexPointSeries TItem="Point"
                             Name="@series.Name"
                             Items="@series.Items"
                             SeriesType="SeriesType.Line"
                             XValue="p => p.X"
                             YValue="p => p.Y"
                             Stroke="@(new ApexCharts.SeriesStroke { Color = "#5c7a89", DashSpace = 0, Width = 3 })" />
        
        }
                               
        {
            <ApexPointSeries TItem="Point"
                             Name=@_child.Name
                             Items="_childPoints"
                             SeriesType="SeriesType.Line"
                             XValue="p => p.X"
                             YValue="p => p.Y"
                             Stroke="@(new ApexCharts.SeriesStroke { Color = "#e27d60", Width = 6 ,DashSpace = 0})" />
        }
    </ApexChart>
}

@code {
    [Parameter] public int Id { get; set; }

    private const decimal MaxAgeMonths = 24m;

    private bool _loading = true;
    private Child? _child;

    private readonly int[] _availablePercentiles = new[] { 1, 3, 5, 15, 25, 50, 75, 85, 95, 97, 99 };

    private IReadOnlyCollection<int> _selectedPercentiles = new List<int> { 3, 15, 50, 85, 97 };

   

    private List<GrowthReferencePoint> _refs = new();
    private List<Point> _childPoints = new();
    private List<Series> _percentileSeries = new();

    private int _chartKey = 1;
    private ApexChartOptions<Point> _options = new();

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;

        var userId = await UserContext.GetUserIdAsync();
        _child = await ChildService.GetChildAsync(Id, userId);

        if (_child is null)
        {
            _loading = false;
            return;
        }

        _refs = await RefService.GetAsync(
            ReferenceSource.Mashhad,
            GrowthMetric.WeightForAge,
            _child.Gender);

        _refs = _refs.Where(r => r.X >= 0 && r.X <= MaxAgeMonths).ToList();

        _childPoints = _child.Measurements
            .Where(m => m.WeightKg > 0)
            .OrderBy(m => m.MeasuredAtUtc)
            .Select(m =>
            {
                var local = m.MeasuredAtUtc.ToLocalTime();
                var ageMonths = AgeMath.AgeInMonths(_child.BirthDate, local);
                return new Point(ageMonths, m.WeightKg);
            })
            .Where(p => p.X >= 0 && p.X <= MaxAgeMonths)
            .ToList();

        RebuildPercentileSeries();
        RebuildOptionsAndRefresh();
        _loading = false;
    }

    private void OnSelectedPercentilesChanged(IReadOnlyCollection<int> values)
    {
        var list = (values ?? Array.Empty<int>()).Distinct().OrderBy(x => x).ToList();
        if (list.Count == 0)
            list = new List<int> { 3, 15, 50, 85, 97 };

        _selectedPercentiles = list;
        RebuildPercentileSeries();
        RebuildOptionsAndRefresh();
    }

    

    private void RebuildOptionsAndRefresh()
    {
        // IMPORTANT: in Blazor-ApexCharts options should not be shared/mutated across instances.
        // Create a NEW options instance each time to ensure changes apply.
        _options = new ApexChartOptions<Point>
        {
            
            Chart = new Chart
            {
                Toolbar = new Toolbar { Show = true },
                Zoom = new Zoom { Enabled = true }
            },
            Xaxis = new XAxis
            {
                Title = new AxisTitle { Text = "سن (ماه)" },
                Min = 0,
                Max = (double)MaxAgeMonths,
                TickAmount = 24
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Title = new AxisTitle { Text = "وزن (Kg)" },
                    Min = 0,
                    Max = 20,
                    TickAmount = 20
                }
            },
            Legend = new Legend
            {
                Show = true,
                Position = LegendPosition.Top
            },
            Stroke = new Stroke
            {
                Curve = Curve.Straight,
                
            },
            // markers: کوچک برای اینکه نقاط مرجع بزرگ نشوند
            Markers = new Markers
            {
                Size =2.5,
                Colors = "#1f2b3g"
            }
        };

        // force full re-render
        _chartKey++;
        StateHasChanged();
    }

    private void RebuildPercentileSeries()
    {
        var selected = _selectedPercentiles.Distinct().OrderBy(x => x).ToList();

        _percentileSeries = selected
            .Select(p => new Series($"P{p}", BuildPercentilePoints(p)))
            .Where(s => s.Items.Count > 0)
            .ToList();
    }

    private List<Point> BuildPercentilePoints(int percentile)
    {
        return _refs
            .Select(r => new { r.X, Y = GetPercentileValue(r, percentile) })
            .Where(x => x.Y.HasValue)
            .Select(x => new Point(x.X, x.Y!.Value))
            .ToList();
    }

    private static decimal? GetPercentileValue(GrowthReferencePoint r, int p) => p switch
    {
        1 => r.P1,
        3 => r.P3,
        5 => r.P5,
        15 => r.P15,
        25 => r.P25,
        50 => r.P50,
        75 => r.P75,
        85 => r.P85,
        95 => r.P95,
        97 => r.P97,
        99 => r.P99,
        _ => null
    };

    public record Point(decimal X, decimal Y);
    private record Series(string Name, List<Point> Items);
}